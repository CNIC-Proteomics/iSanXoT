<template class="task-template" id="panel-main_inputs">
<div id="panel-main_inputs">

  <div class="form-group">
    <h6 for="select-indir">Select input folder</h6>  
    <div class="input-group col-sm">
      <input type="text" class="form-control" placeholder="" id="indir">
      <div class="input-group-append">
        <button class="btn btn-outline-secondary btn-sm select-indir" type="button">Choose folder</button>
      </div>
    </div>
  </div>

  <div class="form-group">
    <h6 for="select-outdir">Select output folder</h6>
    <div class="input-group col-sm">
      <input type="text" class="form-control" placeholder="" id="outdir">
      <div class="input-group-append">
        <button class="btn btn-outline-secondary btn-sm select-outdir" type="button">Choose folder</button>
      </div>
    </div>
  </div>

  <div class="form-group">
    <h6 for="select-species">Select Species</h6>
    <div class="input-group col-sm">
      <select class="custom-select" id="species"></select>
    </div>
  </div>

  <div class="form-group">
    <h6 for="select-dbfile">Select the prefix label of decoy proteins</h6>
    <div class="form-group row col-sm-6">
      <div class="input-group input-group-sm mb-3">
        <div class="input-group-prepend">
          <span class="input-group-text labeldecoy">Decoy label</span>
        </div>
        <input type="text" class="form-control" placeholder="Write Decoy label of your protein database" aria-describedby="labeldecoy" id="labeldecoy">
      </div>  
    </div>
  </div>

  <div class="form-group">
    <h6 for="select-catdb">Select the version of category database</h6>
    <div class="input-group col-sm">
      <select class="custom-select" id="catdb"></select>
    </div>
  </div>

  <h6>Select input files</h6>

</div>
<script>

// Add values to Main_Inputs panel, if apply
function addValuesMainInputsPanel() {
  // Imported variables
  let remote = require('electron').remote;
  let mainWindow = remote.getCurrentWindow();
  let dialog = remote.dialog;
  let exceptor = require(`${__dirname}/renderer-process/exceptor`);
  let importer = require(`${__dirname}/renderer-process/imports`);
  let wf_exec  = importer.wf_exec;
  let wk_id = importer.getWorkIDFromElements(); // get current work id
  let cmd_id = importer.getCmdIDFromElements(); // get the current cmd id
  
  // Init html objects
  // with species
  for (var i = 0; i < wf['species'].length; i++) {
    let wf_species = wf['species'][i];
    $(`#${wk_id} #page-tasktable-${cmd_id} #species`).append(`<option value="${wf_species['scientific']}">${wf_species['name']}</option>`);
  }
  // with database version of categories
  for (var i = 0; i < wf['catdb'].length; i++) {
    let wf_catdbs = wf['catdb'][i];
    $(`#${wk_id} #page-tasktable-${cmd_id} #catdb`).append(`<option value="${wf_catdbs['id']}" >${wf_catdbs['name']}</option>`);
  }

  
  
  // Add values from the loaded project
  if ( 'main_inputs' === wk_id ) {
    // Add main inputs
    if ( wf_exec !== undefined ) {
      if ( 'main_inputs' in wf_exec ) {
        $(`#${wk_id} #page-tasktable-${cmd_id} #indir`).val(`${wf_exec['main_inputs']['indir']}`);
        $(`#${wk_id} #page-tasktable-${cmd_id} #outdir`).val(`${wf_exec['main_inputs']['outdir']}`);
        $(`#${wk_id} #page-tasktable-${cmd_id} #species`).val(`${wf_exec['main_inputs']['species']}`);
        $(`#${wk_id} #page-tasktable-${cmd_id} #labeldecoy`).val(`${wf_exec['main_inputs']['labeldecoy']}`);        
        $(`#${wk_id} #page-tasktable-${cmd_id} #catdb`).val(`${wf_exec['main_inputs']['catid']}`);
      }
    }
  }
  
  /*
   * Events
   */
  // local function for events
  function extractInputDirectoryFile(inputs, errsms) {
    let out = undefined;
    if(inputs === undefined) {
      console.log(`${errsms}: input is undefined`);
      exceptor.showErrorMessageBox('Error Message', `${errsms}`);
    }
    else if (inputs.canceled) {
      console.log(`${errsms}: canceled operation`);
    }
    else if (!('filePaths' in inputs )) {
      console.log(`${errsms}: filePaths does not defined`);
      exceptor.showErrorMessageBox('Error Message', `${errsms}`);
    }
    else {
      if ( inputs['filePaths'].length == 0 ) {
        console.log(`${errsms}: filePaths is empty`);
        exceptor.showErrorMessageBox('Error Message', `${errsms}`);
      }
      else {
        out = inputs['filePaths'][0];
      }
    }
    return out;
  };
  // fill the table with the input files from the given directory
  function fillInputFilesTable(dir) {
    // Imported variables
    let fs = require('fs');

    let files = fs.readdirSync(dir);
    if ( files !== undefined ) {
      for (var i = 0; i < files.length; i++) {
        $(`#${wk_id} #page-tasktable-${cmd_id} .tasktable`).handsontable('setDataAtCell', i, 0, `${dir}/${files[i]}`);
      }
    }
  };

  // events for the INPUT directory and OUTPUT directory
  $(`#${wk_id} #page-tasktable-${cmd_id} button.select-indir`).click(function() {
    dialog.showOpenDialog(mainWindow, { properties: ['openDirectory'] }).then((dirs) => {
      let inpt = extractInputDirectoryFile(dirs, `No input directory selected`);
      if ( inpt !== undefined ) {
        $(`#${wk_id} #page-tasktable-${cmd_id} #indir`).val(`${inpt}`);
        fillInputFilesTable(inpt);
      }      
    });
  });
  $(`#${wk_id} #page-tasktable-${cmd_id} button.select-outdir`).click(function() {
    dialog.showOpenDialog(mainWindow, { properties: ['openDirectory'] }).then((dirs) => {
      let inpt = extractInputDirectoryFile(dirs, `No output directory selected`);
      if ( inpt !== undefined ) {
        $(`#${wk_id} #page-tasktable-${cmd_id} #outdir`).val(`${inpt}`);
      }
    });
  });

} // end addValuesMainInputsPanel


// Create object with the Main_Inputs data extracting from the HTML Elements
function createObjFromMainInputsPanel() {
  let rst = {};
  let main_inputs = $(`#panel-main_inputs [id]`);
  let species = $(`#panel-main_inputs [id=species] option:selected`).text().toLowerCase();
  for (var i = 0; i < main_inputs.length; i++) {
    let inp = main_inputs[i];
    let id = $(inp).attr('id');
    let val = $(inp).val();
    // update category file
    if (id == 'catdb') {
      val = `${process.env.ISANXOT_LIB_HOME}/dbs/${val}/${species}_${val}_sw-tr.categories.tsv`;
    }
    rst[id] = val;
  }
  return rst;
} // end createObjFromMainInputsPanel

</script>
</template>