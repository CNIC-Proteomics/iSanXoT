<template class="task-template" id="panel-input">

<div id="panel-simple">
  <div class="helpadv">
    <svg class="bi text-info" width="30" height="30" fill="currentColor"><use xlink:href="assets/icons/bootstrap-icons-1.3.0/bootstrap-icons.svg#info-square-fill" /></svg>
  </div>
  <div class="help_adp"></div>
</div>
  
<div id="paneladaptor-input">

  <div class="form-group">
    <h6>Output folder</h6>
    <div class="input-group col-sm  adaptor_inputs" id="__OUTDIR__">
      <input type="text" class="form-control" placeholder=""  value="">
      <div class="input-group-append">
        <button class="btn btn-outline-secondary btn-sm" type="button">Choose folder</button>
      </div>
    </div>
  </div>

  <div class="form-group">
    <h6>Default Input folder</h6>  
    <div class="input-group col-sm  adaptor_inputs" id="__INDIR__">
      <input type="text" class="form-control" placeholder=""  value="">
      <div class="input-group-append">
        <button class="btn btn-outline-secondary btn-sm" type="button">Choose folder + Add annots</button>
      </div>
    </div>
  </div>
    
  <fieldset class="scheduler-border">
    <legend class="scheduler-border">Metadata Added from input files (read-only tables)</legend>
    <div class="row">
      <div class="col-8">
        <label>Add and name the experiments</label>
        <div id="add_expcol"></div>
      </div>
      <div class="col-4">
        <label>Add the initial level identifiers</label>
        <div id="add_levelid"></div>
      </div>
    </div>
  </fieldset>

  <fieldset class="scheduler-border">
    <legend class="scheduler-border">Add quantifications</legend>
    <div class="form-check">
      <input class="form-check-input" type="checkbox" value="" id="add_quant_check">
      <label class="form-check-label" for="add_quant_check">Run addQuantif</label>
    </div>
    <div class="form-group">
      <label>mzML Input folder</label>
      <div class="input-group col-sm  adaptor_inputs" id="__MZML_INDIR__">
        <input type="text" class="form-control" placeholder=""  value="">
        <div class="input-group-append">
          <button class="btn btn-outline-secondary btn-sm" type="button">Choose folder</button>
        </div>
      </div>
    </div>        
    <div id="add_quant"></div>
  </fieldset>

  <fieldset class="scheduler-border">
    <legend class="scheduler-border">FDR calculation</legend>
    <div class="form-check">
      <input class="form-check-input" type="checkbox" value="" id="fdr_check">
      <label class="form-check-label" for="fdr_check">Run pRatio</label>
    </div>        
    <div id="fdr"></div>
  </fieldset>

  <fieldset class="scheduler-border">
    <legend class="scheduler-border">Most Probable Protein</legend>
    <div class="form-check">
      <input class="form-check-input" type="checkbox" value="" id="protein_assigner_check">
      <label class="form-check-label" for="protein_assigner_check">Run ProteinAssigner</label>
    </div>        
    <div id="protein_assigner"></div>
  </fieldset>

</div>

<script>

/*
 * Import libraries
 */
let path = require('path');
let url = require('url');
const { dialog, BrowserWindow, ipcMain } = require('electron').remote;
const mainWindow = BrowserWindow.getFocusedWindow();
let commoner = require('./renderer-process/common');
let importer = require('./renderer-process/imports');


/*
 * Declare variables
 */
var annotWindow = undefined;
// Get input parameters (from URL)
let url_params = new URLSearchParams(window.location.search);
let adp_dir = url_params.get('adir');
// get imported variables
let wf  = importer.wf;

/*
 * Local Functions
 */
function extractInputDirectoryFile(inputs, errsms) {
  let out = undefined;
  if(inputs === undefined) {
    console.log(`${errsms}: input is undefined`);
    exceptor.showErrorMessageBox('Error Message', `${errsms}`);
  }
  else if (inputs.canceled) {
    console.log(`${errsms}: canceled operation`);
  }
  else if (!('filePaths' in inputs )) {
    console.log(`${errsms}: filePaths does not defined`);
    exceptor.showErrorMessageBox('Error Message', `${errsms}`);
  }
  else {
    if ( inputs['filePaths'].length == 0 ) {
      console.log(`${errsms}: filePaths is empty`);
      exceptor.showErrorMessageBox('Error Message', `${errsms}`);
    }
    else {
      out = inputs['filePaths'][0];
    }
  }
  return out;
};

// Add the metadata values into the table
function addMetaDataIntoTable(metadata) {
  // add metadata for experiment table
  if ( 'exp' in metadata ) {
    // update the headers based on the metadata
    let h = $(`#add_expcol .tasktable`).handsontable('getColHeader');
    let n = metadata.exp[0].length;
    h = h.slice(0,n);
    // add metadata
    $(`#add_expcol .tasktable`).handsontable({
      data: metadata.exp,
      maxRows: metadata.exp.length,
      colHeaders: h,
      minCols: h.length,
      maxCols: h.length
    });
    $(`#add_expcol .tasktable`).handsontable('render');
  }
  // add metadata for identifier table
  if ( 'ide' in metadata ) {
    $(`#add_levelid .tasktable`).handsontable({
      data: metadata.ide,
      maxRows: metadata.ide.length
    });
    $(`#add_levelid .tasktable`).handsontable('render');
  }
};

/*
 * Local Events
 */

 // Operations when the windows is loaded
$(document).ready(function() {
  // check if tasktables are fill
  let t = [[]];
  t = $('#add_quant .tasktable').handsontable('getData');
  if ( !t.every(commoner.allBlanks) ) $('#add_quant_check').prop("checked",true).trigger('change');
  t = $('#fdr .tasktable').handsontable('getData');
  if ( !t.every(commoner.allBlanks) ) $('#fdr_check').prop("checked",true).trigger('change');
  t = $('#protein_assigner .tasktable').handsontable('getData');
  if ( !t.every(commoner.allBlanks) ) $('#protein_assigner_check').prop("checked",true).trigger('change');
});

 $('#__OUTDIR__  button').click(function() {
  dialog.showOpenDialog(mainWindow, { properties: ['openDirectory'] }).then((dirs) => {
    let inpt = extractInputDirectoryFile(dirs, `No output directory selected`);
    if ( inpt !== undefined ) {
      $(`#__OUTDIR__ input`).val(`${inpt}`);
    }
  });
});
$('#__INDIR__  button').click(function() {
  dialog.showOpenDialog(mainWindow, { properties: ['openDirectory'] }).then((dirs) => {
    let inpt = extractInputDirectoryFile(dirs, `No input directory selected`);
    if ( inpt !== undefined ) {
      $(`#__INDIR__ input`).val(`${inpt}`);
      newAnnotWindow(inpt);
    }
  });
});
$('#__MZML_INDIR__  button').click(function() {
  dialog.showOpenDialog(mainWindow, { properties: ['openDirectory'] }).then((dirs) => {
    let inpt = extractInputDirectoryFile(dirs, `No input directory selected`);
    if ( inpt !== undefined ) {
      $(`#__MZML_INDIR__ input`).val(`${inpt}`);
    }
  });
});

/* Checkbox for the sub-modules */
$('#add_quant_check').change(function() {
  let i = 'add_quant'
  if ( this.checked ) {
    // enable
    $(`#${i} .wtHider`).css('pointer-events','inherit');
    $(`#${i} .wtHider`).css('opacity','1');
    $(`#__MZML_INDIR__`).css('pointer-events','inherit');
    $(`#__MZML_INDIR__`).css('opacity','1');
    // add class to save the table
    $(`#${i} .hot`).addClass('tasktable');
    // if task-table is empty, then fill it with the values from metadata task-table
    t = $(`#${i} .tasktable`).handsontable('getData');
    if ( t.every(commoner.allBlanks) ) {
      d = $('#add_expcol .tasktable').handsontable('getData');
      $(`#${i} .tasktable`).handsontable({data: d });
    }
  }
  else {
    // disable
    $(`#${i} .wtHider`).css('pointer-events','none');
    $(`#${i} .wtHider`).css('opacity','0.8');
    $(`#__MZML_INDIR__`).css('pointer-events','none');
    $(`#__MZML_INDIR__`).css('opacity','0.8');
    // remove class to don't save tbe table
    $(`#${i} .hot`).removeClass('tasktable');
  }
});
$('#fdr_check').change(function() {
  let i = 'fdr'
  if ( this.checked ) {
    // enable
    $(`#${i} .wtHider`).css('pointer-events','inherit');
    $(`#${i} .wtHider`).css('opacity','1');
    // add class to save the table
    $(`#${i} .hot`).addClass('tasktable');
  }
  else {
    // disable
    $(`#${i} .wtHider`).css('pointer-events','none');
    $(`#${i} .wtHider`).css('opacity','0.8');
    // remove class to don't save tbe table
    $(`#${i} .hot`).removeClass('tasktable');
  }
});
$('#protein_assigner_check').change(function() {
  let i = 'protein_assigner'
  if ( this.checked ) {
    // enable
    $(`#${i} .wtHider`).css('pointer-events','inherit');
    $(`#${i} .wtHider`).css('opacity','1');
    // add class to save the table
    $(`#${i} .hot`).addClass('tasktable');
  }
  else {
    // disable
    $(`#${i} .wtHider`).css('pointer-events','none');
    $(`#${i} .wtHider`).css('opacity','0.8');
    // remove class to don't save tbe table
    $(`#${i} .hot`).removeClass('tasktable');
  }
});


/* Functions that chech the inputs */
function checkInputFile(input, errsms, exceptor) {
  let fs = require('fs');
  if ( $(`${input}`).val() === undefined || $(`${input}`).val() === '' ) {
      console.log(`${errsms}: input is undefined`);
      exceptor.showErrorMessageBox('Error Message', `${errsms}`, end=true);
    }
    else {
      try {
        if ( !fs.existsSync($(`${input}`).val()) ) {
          console.log(`${errsms}: input is undefined`);
          exceptor.showErrorMessageBox('Error Message', `${errsms}`, end=true);
        }
      } catch(err) {
        console.log(`${errsms}: input is undefined`);
        // exceptor.showErrorMessageBox('Error Message', `${errsms}`, end=true);
      }
    }
    return;
};
/* The name and the parameters of this function has to be the same in the adaptors */
function checkAdaptorInputs(exceptor) {
  checkInputFile(`#__INDIR__ input`, `Input folder has not been included`, exceptor);
  checkInputFile(`#__OUTDIR__ input`, `Output folder has not been included`, exceptor);
};

/* Window to add the metadata from inputs */
function newAnnotWindow(input_folder) {
  if ( annotWindow === undefined || annotWindow.isDestroyed() ) {
        annotWindow = new BrowserWindow({
            title: 'Add metadata from input files',
            width: 1000,
            height: 900,
            webPreferences: {
                nodeIntegration: true,
                contextIsolation: false,
                enableRemoteModule: true
            },
            minimizable: false,
            resizable: false,
            'icon': process.env.ISANXOT_ICON,
            parent: mainWindow
        });
        annotWindow.setMenu(null);
        annotWindow.show();
        // disable the events in the document
        document.body.style.pointerEvents = 'none';
        // don't show the menu
        mainWindow.menuBarVisible = false;
    }

    // annotWindow.webContents.openDevTools();

    // create the URL
    annotWindow.loadURL(
      url.format({
            protocol: 'file',
            pathname: path.join(adp_dir, 'panels/metadata.html'),
            query: {
              'libdir': __dirname,
              'inpdir': input_folder
            }
      })
    ).catch( (error) => {
        console.log(error);
    });
    // Emitted when the window is starting to be close.
    annotWindow.on('close', function(event) {
      // enamble the events in the document
      document.body.style.pointerEvents = '';
      // show the menu
      mainWindow.menuBarVisible = true;
      // give the focus
      mainWindow.focus();
    });
}

/*
 * Renderer functions
 */

// Renderer functions from the window "Add metadata"
ipcMain.on('submitmetadata', (event, metadata) => {

  // add metadata values in the table
  addMetaDataIntoTable(metadata);
  // enable opacity
  $(`#add_expcol .wtHider`).css('opacity','1');
  $(`#add_levelid .wtHider`).css('opacity','1');

});


</script>
</template>